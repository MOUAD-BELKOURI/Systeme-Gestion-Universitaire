<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sidebar {
        min-height: 100vh;
        background: #2c3e50;
    }
    .sidebar .nav-link {
        color: #ecf0f1;
        padding: 15px 20px;
        border-left: 4px solid transparent;
    }
    .sidebar .nav-link:hover, .sidebar .nav-link.active {
        background: #34495e;
        border-left: 4px solid #3498db;
    }
    .content {
        background: #f8f9fa;
        min-height: 100vh;
    }

    /* Statistiques avec cercles */
    .circle-stat-container {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 30px;
    }

    .circle-stat-card {
      flex: 1;
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transition: transform 0.3s;
      display: flex;
      align-items: center;
      gap: 20px;
      border-top: 4px solid;
    }

    .circle-stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .circle-stat-card.students {
      border-top-color: #3498db;
    }

    .circle-stat-card.teachers {
      border-top-color: #2ecc71;
    }

    .circle-stat-card.modules {
      border-top-color: #9b59b6;
    }

    .circle-stat-card.filieres {
      border-top-color: #e74c3c;
    }

    .circle-wrapper {
      position: relative;
      width: 100px;
      height: 100px;
      flex-shrink: 0;
    }

    .circle-canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .circle-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .circle-value {
      font-size: 1.8rem;
      font-weight: 700;
      line-height: 1;
      color: #2c3e50;
    }

    .circle-label {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-top: 2px;
    }

    .stat-info {
      flex: 1;
    }

    .stat-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .stat-subtitle {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-bottom: 15px;
    }

    /* Graphiques */
    .charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      height: 350px;
      display: flex;
      flex-direction: column;
    }

    .chart-header {
      margin-bottom: 20px;
      border-bottom: 1px solid #ecf0f1;
      padding-bottom: 15px;
    }

    .chart-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2c3e50;
      margin: 0;
    }

    .chart-subtitle {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-top: 5px;
    }

    .chart-body {
      flex: 1;
      position: relative;
    }

    /* Actions rapides */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .action-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transition: all 0.3s;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .action-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
      color: inherit;
    }

    .action-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 1.5rem;
    }

    .action-icon.primary {
      background: rgba(52, 152, 219, 0.1);
      color: #3498db;
    }

    .action-icon.success {
      background: rgba(46, 204, 113, 0.1);
      color: #2ecc71;
    }

    .action-icon.info {
      background: rgba(155, 89, 182, 0.1);
      color: #9b59b6;
    }

    .action-icon.warning {
      background: rgba(241, 196, 15, 0.1);
      color: #f39c12;
    }

    .action-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .action-desc {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin: 0;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .circle-stat-container {
        flex-wrap: wrap;
      }

      .circle-stat-card {
        flex: 0 0 calc(50% - 10px);
      }

      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 992px) {
      .charts-container {
        grid-template-columns: 1fr;
      }

      .circle-stat-card {
        flex: 0 0 100%;
      }
    }

    @media (max-width: 768px) {
      .quick-actions {
        grid-template-columns: 1fr;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-in {
      animation: fadeIn 0.5s ease forwards;
    }

    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }
    .delay-5 { animation-delay: 0.5s; }
    .delay-6 { animation-delay: 0.6s; }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
      <div class="position-sticky pt-3">
        <div class="text-center text-white p-3">
          <h4><i class="fas fa-university"></i> Administration</h4>
          <p class="text-muted small">Bienvenue, <span th:text="${user.nom}"></span></p>
        </div>
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" href="/admin/dashboard">
              <i class="fas fa-tachometer-alt"></i> Tableau de bord
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/etudiants">
              <i class="fas fa-users"></i> Étudiants
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/enseignants">
              <i class="fas fa-chalkboard-teacher"></i> Enseignants
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/modules">
              <i class="fas fa-book"></i> Modules
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/emploi-temps">
              <i class="fas fa-calendar-alt"></i> Emploi du temps
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/filieres">
              <i class="fas fa-graduation-cap"></i> Filières
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/salles">
              <i class="fas fa-door-open"></i> Salles
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/admins">
              <i class="fas fa-user-shield"></i> Administrateurs
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/profile">
              <i class="fas fa-user"></i> Mon profil
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/logout">
              <i class="fas fa-sign-out-alt"></i> Déconnexion
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 content">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
        <h1><i class="fas fa-tachometer-alt"></i> Tableau de bord</h1>
        <div class="text-muted">
          <i class="far fa-calendar-alt me-2"></i>
          <span id="current-date"></span>
        </div>
      </div>

      <!-- Alertes -->
      <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mb-4">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <div th:if="${success}" class="alert alert-success alert-dismissible fade show mb-4">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <!-- Statistiques avec cercles - 4 en haut côte à côte -->
      <div class="circle-stat-container">
        <div class="circle-stat-card students animate-in delay-1">
          <div class="circle-wrapper">
            <canvas class="circle-canvas" id="studentsChart"></canvas>
            <div class="circle-text">
              <div class="circle-value" th:text="${totalEtudiants != null ? totalEtudiants : '0'}">0</div>
              <div class="circle-label">Étudiants</div>
            </div>
          </div>
          <div class="stat-info">
            <div class="stat-title">Étudiants</div>
            <div class="stat-subtitle">Total inscrits dans le système</div>
            <a href="/admin/etudiants" class="btn btn-sm btn-primary">Voir détails</a>
          </div>
        </div>

        <div class="circle-stat-card teachers animate-in delay-2">
          <div class="circle-wrapper">
            <canvas class="circle-canvas" id="teachersChart"></canvas>
            <div class="circle-text">
              <div class="circle-value" th:text="${totalEnseignants != null ? totalEnseignants : '0'}">0</div>
              <div class="circle-label">Enseignants</div>
            </div>
          </div>
          <div class="stat-info">
            <div class="stat-title">Enseignants</div>
            <div class="stat-subtitle">Enseignants actifs</div>
            <a href="/admin/enseignants" class="btn btn-sm btn-success">Voir détails</a>
          </div>
        </div>

        <div class="circle-stat-card modules animate-in delay-3">
          <div class="circle-wrapper">
            <canvas class="circle-canvas" id="modulesChart"></canvas>
            <div class="circle-text">
              <div class="circle-value" th:text="${totalModules != null ? totalModules : '0'}">0</div>
              <div class="circle-label">Modules</div>
            </div>
          </div>
          <div class="stat-info">
            <div class="stat-title">Modules</div>
            <div class="stat-subtitle">Modules en cours</div>
            <a href="/admin/modules" class="btn btn-sm btn-info">Voir détails</a>
          </div>
        </div>

        <div class="circle-stat-card filieres animate-in delay-4">
          <div class="circle-wrapper">
            <canvas class="circle-canvas" id="filieresChart"></canvas>
            <div class="circle-text">
              <div class="circle-value" th:text="${totalFilieres != null ? totalFilieres : '0'}">0</div>
              <div class="circle-label">Filières</div>
            </div>
          </div>
          <div class="stat-info">
            <div class="stat-title">Filières</div>
            <div class="stat-subtitle">Filières disponibles</div>
            <a href="/admin/filieres" class="btn btn-sm btn-warning">Voir détails</a>
          </div>
        </div>
      </div>

      <!-- Graphiques sous les cercles -->
      <div class="charts-container">
        <div class="chart-card animate-in delay-5">
          <div class="chart-header">
            <h3 class="chart-title"><i class="fas fa-chart-bar me-2"></i>Répartition par filière</h3>
            <p class="chart-subtitle">Nombre d'étudiants par filière</p>
          </div>
          <div class="chart-body">
            <canvas id="repartitionChart"></canvas>
          </div>
        </div>

        <div class="chart-card animate-in delay-6">
          <div class="chart-header">
            <h3 class="chart-title"><i class="fas fa-chart-line me-2"></i>Évolution mensuelle</h3>
            <p class="chart-subtitle">Nouveaux étudiants par mois</p>
          </div>
          <div class="chart-body">
            <canvas id="evolutionChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Actions rapides -->
      <div class="quick-actions">
        <a href="/admin/etudiants/create" class="action-card animate-in">
          <div class="action-icon primary">
            <i class="fas fa-user-plus"></i>
          </div>
          <h4 class="action-title">Nouvel étudiant</h4>
          <p class="action-desc">Ajouter un étudiant au système</p>
        </a>

        <a href="/admin/enseignants/create" class="action-card animate-in" style="animation-delay: 0.1s">
          <div class="action-icon success">
            <i class="fas fa-chalkboard-teacher"></i>
          </div>
          <h4 class="action-title">Nouvel enseignant</h4>
          <p class="action-desc">Ajouter un nouvel enseignant</p>
        </a>

        <a href="/admin/modules/create" class="action-card animate-in" style="animation-delay: 0.2s">
          <div class="action-icon info">
            <i class="fas fa-book-medical"></i>
          </div>
          <h4 class="action-title">Nouveau module</h4>
          <p class="action-desc">Créer un module d'enseignement</p>
        </a>

        <a href="/admin/emploi-temps/create" class="action-card animate-in" style="animation-delay: 0.3s">
          <div class="action-icon warning">
            <i class="fas fa-calendar-plus"></i>
          </div>
          <h4 class="action-title">Nouvelle séance</h4>
          <p class="action-desc">Planifier une séance de cours</p>
        </a>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
  /*<![CDATA[*/
  // Données pour les graphiques
  var repartitionData = /*[[${repartitionParFiliere}]]*/ {};
  var repartitionLabels = [];
  var repartitionValues = [];

  if (repartitionData && typeof repartitionData === 'object') {
    for (var key in repartitionData) {
      if (repartitionData.hasOwnProperty(key)) {
        repartitionLabels.push(key);
        repartitionValues.push(repartitionData[key]);
      }
    }
  }

  // Si pas de données, utiliser des données par défaut
  if (repartitionLabels.length === 0) {
    repartitionLabels = ['Informatique', 'Maths', 'Physique', 'Chimie', 'Biologie'];
    repartitionValues = [120, 80, 60, 45, 35];
  }
  /*]]>*/
</script>
<script>
  // Date et heure
  function updateDate() {
    const now = new Date();
    const date = now.toLocaleDateString('fr-FR', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    document.getElementById('current-date').textContent = date;
  }
  updateDate();

  // Créer les cercles de statistiques
  function createCircleChart(canvasId, value, maxValue, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const percentage = (value / maxValue) * 100;

    return new Chart(ctx, {
      type: 'doughnut',
      data: {
        datasets: [{
          data: [percentage, 100 - percentage],
          backgroundColor: [color, '#ecf0f1'],
          borderWidth: 0,
          circumference: 360
        }]
      },
      options: {
        cutout: '75%',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        },
        animation: {
          animateScale: true,
          animateRotate: true
        }
      }
    });
  }

  // Créer le graphique de répartition
  function createRepartitionChart() {
    const ctx = document.getElementById('repartitionChart').getContext('2d');

    // Utiliser les données depuis le script inline Thymeleaf
    const labels = window.repartitionLabels || ['Informatique', 'Maths', 'Physique', 'Chimie', 'Biologie'];
    const data = window.repartitionValues || [120, 80, 60, 45, 35];

    return new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Étudiants',
          data: data,
          backgroundColor: [
            'rgba(52, 152, 219, 0.8)',
            'rgba(46, 204, 113, 0.8)',
            'rgba(155, 89, 182, 0.8)',
            'rgba(241, 196, 15, 0.8)',
            'rgba(231, 76, 60, 0.8)',
            'rgba(52, 73, 94, 0.8)',
            'rgba(230, 126, 34, 0.8)',
            'rgba(142, 68, 173, 0.8)'
          ],
          borderRadius: 6,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              drawBorder: false
            },
            ticks: {
              stepSize: function() {
                const max = Math.max(...data);
                return Math.ceil(max / 5);
              }
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  }

  function createEvolutionChart() {
    const ctx = document.getElementById('evolutionChart').getContext('2d');
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'],
        datasets: [{
          label: 'Nouveaux étudiants',
          data: [12, 19, 15, 25, 22, 30, 28, 10, 35, 40, 32, 45],
          borderColor: '#2ecc71',
          backgroundColor: 'rgba(46, 204, 113, 0.1)',
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointBackgroundColor: '#2ecc71',
          pointBorderColor: 'white',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              drawBorder: false
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  }

  // Initialiser les graphiques
  document.addEventListener('DOMContentLoaded', function() {
    // Récupérer les valeurs dynamiques
    const studentsValue = parseInt(document.querySelectorAll('.circle-value')[0].textContent) || 0;
    const teachersValue = parseInt(document.querySelectorAll('.circle-value')[1].textContent) || 0;
    const modulesValue = parseInt(document.querySelectorAll('.circle-value')[2].textContent) || 0;
    const filieresValue = parseInt(document.querySelectorAll('.circle-value')[3].textContent) || 0;

    console.log('Valeurs récupérées:', {
      students: studentsValue,
      teachers: teachersValue,
      modules: modulesValue,
      filieres: filieresValue
    });

    // Calculer les valeurs max pour les cercles
    const maxValues = {
      students: Math.max(studentsValue * 1.5, 100),
      teachers: Math.max(teachersValue * 2, 20),
      modules: Math.max(modulesValue * 2, 50),
      filieres: Math.max(filieresValue * 2, 10)
    };

    // Créer les cercles
    try {
      createCircleChart('studentsChart', studentsValue, maxValues.students, '#3498db');
      createCircleChart('teachersChart', teachersValue, maxValues.teachers, '#2ecc71');
      createCircleChart('modulesChart', modulesValue, maxValues.modules, '#9b59b6');
      createCircleChart('filieresChart', filieresValue, maxValues.filieres, '#e74c3c');
    } catch (error) {
      console.error('Erreur lors de la création des cercles:', error);
    }

    // Créer les graphiques
    try {
      createRepartitionChart();
      createEvolutionChart();
    } catch (error) {
      console.error('Erreur lors de la création des graphiques:', error);
    }

    // Animation
    const animatedElements = document.querySelectorAll('.animate-in');
    animatedElements.forEach(el => {
      el.style.opacity = '0';
    });

    setTimeout(() => {
      animatedElements.forEach(el => {
        el.style.opacity = '1';
      });
    }, 100);
  });
</script>
</body>
</html>